% Don't have blank pages for the PDF version, but
% make sure content starts on the right hand side for the
% print version.
%\ifx\forprint\undefined
%\documentclass[oneside]{book}                            
%\else
\documentclass[twoside,openright]{book}                            
%\fi
                                                                        
%\usepackage[T1]{fontenc}
%\usepackage{c64pro}

\usepackage[sfdefault]{roboto}   

% Usage of /href
\usepackage[hidelinks]{hyperref}
% Disable decoration

\hypersetup{ pdfauthor={Rob Hogan},                         
pdftitle={Psychedelia Syndrome},                           
pdfkeywords={C64 6502 Llamasoft Psychedelia Colorspace Jeff Minter}}

\usepackage[margin=1in]{geometry}                                       
\setlength\paperwidth{7.5in}                                            
  \setlength\paperheight{9.25in}                                        
 \setlength\textwidth{5.2in}                                            
 \setlength\textheight{7.2in}      

% Math formulas!
\usepackage{amsmath}

 %Nice header with pages numbers                                         
\usepackage{fancyhdr}                                                   
\lhead[\leftmark]{}
\rhead[]{\leftmark}

%------------- IMGs ------------------
\usepackage{graphicx}                                                   
\newcommand{\surface}[1]{%
\setlength{\fboxsep}{3pt}%
\setlength{\fboxrule}{0pt}%
\fbox{\includegraphics[width=\textwidth]{#1}}%
}%
\usepackage{graphicx}                                                   
\newcommand{\img}[1]{%
\setlength{\fboxsep}{0pt}%
\setlength{\fboxrule}{1pt}%
\fbox{\includegraphics[width=\textwidth]{\base/illu/img/#1}}%
}%
\newcommand{\sbimg}[2]{%
\setlength{\fboxsep}{0pt}%
\setlength{\fboxrule}{1pt}%
\fbox{\includegraphics[width=#1\textwidth]{\base/illu/img/#2}}%
}%
\newcommand{\draw}[1]{%
\setlength{\fboxsep}{0pt}%
\setlength{\fboxrule}{1pt}%
\fbox{\includegraphics[width=\textwidth]{\base/illu/d/#1.png}}%
}%
\newcommand{\sbdraw}[2]{%
\setlength{\fboxsep}{0pt}%
\setlength{\fboxrule}{1pt}%
\fbox{\includegraphics[width=#1\textwidth]{\base/illu/d/#2.png}}%
}%

%------------- NO BORDER IMG ------------------
\usepackage{graphicx}                                                   
\newcommand{\nbimg}[1]{%
\includegraphics[width=\textwidth]{\base/illu/img/#1}%
}%
\newcommand{\nbdraw}[1]{%
\includegraphics[width=\textwidth]{\base/illu/d/#1.png}%
}%

%------------- SCALED IMG ------------------
\newcommand{\simg}[2]{%
{\centering\includegraphics[width=#1\textwidth]{\base/illu/img/#2}\par}%
}%
\newcommand{\sdraw}[2]{%
{\centering\includegraphics[width=#1\textwidth]{\base/illu/d/#2.png}\par}%
}%



%------------- IMGs ------------------

\newcommand{\red}[1]{%
{\color{red}#1}%
}%

%Prevent latex from vertical justifing                                  
\raggedbottom 

\setlength{\parindent}{0em}                                             
\setlength{\parskip}{1em}  

%make footnote stick to the bottom of the page                          
\usepackage[bottom]{footmisc}                                           

\usepackage{subfiles}

% ARRAYS
%----------------------------
\usepackage{array}
\usepackage{booktabs}  
% Color header row 
\usepackage[table]{xcolor}
%----------------------------
\usepackage{varwidth} %for the varwidth minipage environment

\newcolumntype{M}{>{\begin{varwidth}{4cm}}l<{\end{varwidth}}} %M is for Maximal column

% Used to force figure to now float (with \begin{figure}[H]).
\usepackage{float}


% Create blank page for print version of the book
\usepackage{afterpage}
\newcommand\blankpage{%
    \null
    \thispagestyle{empty}%
    \addtocounter{page}{-1}%
    \newpage}


% Reduce padding between figure and caption
\usepackage[justification=centering,labelfont=bf]{caption}
%\captionsetup{belowskip=-15pt, aboveskip=8pt}
\captionsetup[lstlisting]{font=footnotesize,labelfont=footnotesize}
\captionsetup[figure]{font=footnotesize,labelfont=footnotesize}
\captionsetup[subfigure]{font=footnotesize,labelfont=footnotesize,labelformat=empty}

% Cover is a pdf that is included
\usepackage{pdfpages}

% quotes
\usepackage{tcolorbox}
\usepackage{xparse}
\NewDocumentEnvironment{q}{m}
{
\begin{tcolorbox}[parbox=false, sharp corners,after skip=10pt]%
}
{ 

\hspace*{\fill} --- #1\\
\end{tcolorbox}%
}

% Help avoiding line overflow
\emergencystretch 1em

% Remove Chapter "chapter" and chapter number
\usepackage{titlesec}
\usepackage{lipsum}
\titleformat{\chapter}[display]
  {\normalfont\bfseries}{}{0pt}{\Huge}
    
\usepackage{multirow,tabularx} % in the preamble
\newcolumntype{Y}{>{\centering\arraybackslash}X}

% Trivia:
% For trivia left margin
\usepackage{scrextend}
\usepackage{mdframed}
\newmdenv[
  topline=false,
  bottomline=false,
  rightline=false,
]{siderules}

\newenvironment{trivia}{
\begin{siderules}[linewidth=0.7mm,innerrightmargin=0cm,]
\textbf{Trivia:}%
}%
{\end{siderules}}%

% Bibliography
\usepackage[super,square]{natbib}
\bibliographystyle{unsrt}

% To enable figures at the bottom of page
\usepackage{dblfloatfix}

\usepackage{fancyvrb}

\definecolor{bg_color}{HTML}{EEEEEE}

% Copy part of a file to a temporary file.
% This function is necessary when listing snippets from our
% large asm files using \lstinputlisting. It seems that \lstinputlist
% will parse the entire file up to the position of the snippet each
% time, making compile performance terrible (many minutes on more than
% just a dozen snippets). Using this function to copy the part of the
% file we're interested into a temporary file and using that as the input
% to \lstinputlisting reduces compile time to seconds again.
% See https://tex.stackexchange.com/questions/669081/lstinputlisting-always-parses-entire-source-file
\ExplSyntaxOn
\NewDocumentCommand \CopyPartialFile {mmmm} {
\def\fromlines{\numexpr #3 - 1}
\ior_open:Nn \g_tmpa_ior {#1}
\iow_open:Nn \g_tmpa_iow {#2}
\prg_replicate:nn {\fromlines} {
    \ior_str_get:NN \g_tmpa_ior \l_tmpa_str
}
\def\tolines{\numexpr #4 - \fromlines}
\prg_replicate:nn {\tolines} {
    \ior_str_get:NN \g_tmpa_ior \l_tmpa_str
    \iow_now:Nx \g_tmpa_iow {\l_tmpa_str}
}
\ior_close:N \g_tmpa_ior
\iow_close:N \g_tmpa_iow
}
\ExplSyntaxOff

% FIXME: change draft to final when producing final version
% This is necessary because lstinputlisting is really slow.
\usepackage[final]{listings}
\lstset{ 
  backgroundcolor=\color{bg_color},
  breaklines=true,
   frame=single,
   basicstyle=\footnotesize\ttfamily,
   xleftmargin=9pt,
   framexleftmargin=5pt,
   showstringspaces=false,
   aboveskip=12pt,
   belowskip=0pt,
   % Make some parts appear in red.
   moredelim=**[is][\color{red}]{@}{@},
}

\lstdefinelanguage
   [6502]{Assembler}     % add a "x64" dialect of Assembler
   [x86masm]{Assembler} % based on the "x86masm" dialect
   % with these extra keywords:
	 {
   morekeywords={.BYTE,LDY,LDX,INC,LDA,BEQ,BNE,JSR,DEY,DEX,PHA,PLA,INY,BPL,CPX, %
									STA,SEC,SBC,BCS,EOR,RTS,SEI,TXA,ASL,TAY,INX,CPY,TAX,RTI,TYA,BRK,.TEXT}
	 } % etc.

\lstdefinelanguage
   [C64Basic]{Basic}     % add a "x64" dialect of Assembler
   % with these extra keywords:
   {
   morecomment=[n]{(*}{*)},
	 morecomment=[s]{***}{***},
	 morestring=[b]",
	 morekeywords={REM, POKE, READX, GETA, NEXT, IF, AND, END,
								 CHRS, WAIT, THEN, FOR, TO, READ, PRINT, DATA}
	 }%

\definecolor{mGreen}{rgb}{0,0.6,0}
\definecolor{mGray}{rgb}{0.5,0.5,0.5}
\definecolor{keyword_color}{rgb}{0.00,0,1.0}


\lstdefinestyle{C64BasicStyle}{
    backgroundcolor=\color{bg_color},   
    commentstyle=\color{mGreen},
    keywordstyle=\color{keyword_color},
    numberstyle=\color{mGray},
    stringstyle=\color{mGreen},
    breakatwhitespace=false,         
    breaklines=true,                 
    captionpos=b,                    
    keepspaces=true,                                  
    showspaces=false,                
    showstringspaces=false,
    showtabs=false,                  
    tabsize=1,
    language=[C64Basic]Basic,
    morekeywords={call, ld, or, jr,ldr, str,ldir, EI, IM, .area}
}

\lstdefinestyle{6502Style}{
    backgroundcolor=\color{bg_color},   
    commentstyle=\color{mGreen},
    keywordstyle=\color{keyword_color},
    numberstyle=\color{mGray},
    stringstyle=\color{mGreen},
    breakatwhitespace=false,         
    breaklines=true,                 
    captionpos=b,                    
    keepspaces=true,                                  
    showspaces=false,                
    showstringspaces=false,
    showtabs=false,                  
    tabsize=1,
    language=[6502]Assembler,
    morekeywords={call, ld, or, jr,ldr, str,ldir, EI, IM, .area}
}


\lstloadlanguages{[6502]Assembler}

% KANJIS!
\usepackage{CJKutf8}

% Inline code
\usepackage{xcolor}
\definecolor{code_bg_color}{HTML}{CCCCCC}

% Some color definitions.
% FIXME: Ensure these definitions match the colors as defined by C64.
\definecolor{lightgreen}{rgb}{0.56, 0.93, 0.56}
\definecolor{lightblue}{rgb}{0.68, 0.85, 0.9}
\definecolor{lightred}{rgb}{1.0, 0.25, 0.25}

\usepackage{tcolorbox}
\tcbuselibrary{most}
\newtcbox{\entoure}[1][code_bg_color]{on line,
arc=3pt,colback=#1!10!code_bg_color,colframe=#1!50!code_bg_color,
before upper={\rule[-3pt]{0pt}{10pt}},boxrule=0pt,
boxsep=0pt,left=2pt,right=2pt,top=2pt,bottom=.5pt}

% layer colors
\definecolor{mycyan}{HTML}{00FFFF}
\definecolor{mypink}{HTML}{FF00FF}
\definecolor{myyellow}{HTML}{FFFF00}

\definecolor{mask1}{HTML}{ddcc99}
\definecolor{mask2}{HTML}{998855}
\definecolor{mask3}{HTML}{776633}
\definecolor{mask4}{HTML}{554400}


\definecolor{mask5}{HTML}{556677}
\definecolor{mask6}{HTML}{445566}
\definecolor{mask7}{HTML}{99aabb}
\definecolor{mask8}{HTML}{778899}


\definecolor{mask9}{HTML}{223344}
\definecolor{maska}{HTML}{777766}
\definecolor{maskb}{HTML}{666655}
\definecolor{maskc}{HTML}{666666}

\definecolor{c64_black}{HTML}{000000}
\definecolor{c64_white}{HTML}{ffffff}
\definecolor{c64_red}{HTML}{880000}
\definecolor{c64_cyan}{HTML} {aaffee}
\definecolor{c64_violet}{HTML}{cc44cc}
\definecolor{c64_purple}{HTML}{cc44cc}
\definecolor{c64_green}{HTML}{00cc55}
\definecolor{c64_blue}{HTML} {0000aa}
\definecolor{c64_yellow}{HTML} {eeee77}
\definecolor{c64_orange}{HTML} {dd8855}
\definecolor{c64_brown}{HTML}{664400}
\definecolor{c64_lightred}{HTML}{ff7777}
\definecolor{c64_ltred}{HTML}{ff7777}
\definecolor{c64_darkgrey}{HTML}{333333}
\definecolor{c64_grey}{HTML} {333333}
\definecolor{c64_grey1}{HTML} {333333}
\definecolor{c64_grey2}{HTML} {777777}
\definecolor{c64_darkgray}{HTML}{333333}
\definecolor{c64_gray}{HTML} {333333}
\definecolor{c64_gray1}{HTML} {333333}
\definecolor{c64_gray2}{HTML} {777777}
\definecolor{c64_lightgreen}{HTML}{aaff66}
\definecolor{c64_lightblue}{HTML} {0088ff}
\definecolor{c64_lightgrey}{HTML}{bbbbbb}
\definecolor{c64_lightgray}{HTML}{bbbbbb}
\definecolor{c64_ltgreen}{HTML}{aaff66}
\definecolor{c64_ltblue}{HTML} {0088ff}
\definecolor{c64_ltgrey}{HTML}{bbbbbb}
\definecolor{c64_ltgray}{HTML}{bbbbbb}
\definecolor{c64_grey3}{HTML}{bbbbbb}
\definecolor{c64_gray3}{HTML}{bbbbbb}

\newcommand*{\icode}[1]{{\texttt{#1}}}
\newcommand*{\bicode}[1]{{\textbf{\texttt{#1}}}}

\newcommand{\smallcube}[2]{%
\setlength{\fboxsep}{0pt}%
\setlength{\fboxrule}{1pt}%
\fcolorbox{#1}{#2}{\vphantom{W}\hphantom{H}}%
}


% To categories games
\newcommand{\ocube}{%
\smallcube{black}{gray}%
}
\newcommand{\platcube}{%
\smallcube{black}{cyan}%
}

\newcommand{\beatallcube}{%
\smallcube{black}{magenta}%
}
\newcommand{\shmupcube}{%
\smallcube{black}{yellow}%
}
\newcommand{\duelcube}{%
\smallcube{black}{black}%
}
\newcommand{\po}{%
\smallcube{white}{white}%
}

% Place lstlisting inside minipage to avoid page break inside listing
\lstnewenvironment{code}
{\minipage{\linewidth}}
{\endminipage}

\usepackage{adjustbox}

\usepackage{tikz}
\usetikzlibrary{matrix}
\usetikzlibrary{arrows.meta}

\newcommand*\circled[1]{\tikz[baseline=(char.base)]{\node[shape=circle,draw,inner sep=1pt] (char) {#1};}}
\usetikzlibrary{positioning,shapes}


% Used to strike words with \sout
% \usepackage[normalem]{ulem}

% Wrap figure
\usepackage{wrapfig}

\usepackage{amssymb}

% Automagically remove header and footer from empty pages.
\usepackage{emptypage}

%Index stuff
\usepackage{imakeidx}
\makeindex[columns=2, title=Index,intoc]

%Remove space above itemize
\usepackage{enumitem}

%For the music sheets.
\usepackage{abc}

% for mu symbol    
\usepackage{textcomp}
\usepackage{upgreek}

% To generate version number!
\usepackage{datetime}
\renewcommand{\dateseparator}{, }
\newdateformat{monthyeardate}{\monthname\dateseparator\THEYEAR}

\usepackage{subcaption}

% For end of book empty page (checkoddpage)
\usepackage{ifoddpage}

\usepackage{overpic}
\usepackage{pict2e}

\usepackage{pgfplots}
\usepackage{pgfplotstable}
\usepackage{makecell}

\usepackage{attachfile}
\usepackage{pdflscape}
\usepackage[figuresright]{rotating}

\usepackage[
  type={CC},
  modifier={by-nc-sa},
  version={3.0},
]{doclicense}

\begin{document}    
\ifx\forprint\undefined
\includepdf{\base/illu/cover_front.pdf}
\else
\blankpage
\blankpage
\fi

\subfile{src/copyright}

% Make page number appear on botton right                               
\pagestyle{fancy}                                                       
\fancyfoot{}                                                            
\fancyfoot[EL]{\thepage}                                                
\fancyfoot[OR]{\thepage} 
\tableofcontents 

\subfile{src/preface} %draft
\subfile{src/listing} % draft
%\subfile{src/listing_pattern} % draft
%\subfile{src/listing_commentary} % draft
%\subfile{src/patterns} % draft
%\subfile{src/symmetries} % draft
%\subfile{src/bursts} % draft
%\subfile{src/presets} % draft
%\subfile{src/sequencer} % draft
%\subfile{src/pulsespeed} % draft
%\subfile{src/pulsewidth} % draft
%\subfile{src/linewidth} % draft
%\subfile{src/delay} % draft
%\appendix
%\chapter*{Appendices}

% Obsolete
%\subfile{src/level_data_appendix_detail} % draft obsolete?
%\subfile{src/evolutions} % draft

\printindex

% Add these later

\ifx\forprint\undefined
   \includepdf{\base/illu/cover_back.pdf}
\else
    % Adding the right number of bankpage automatically at the end is tricky.
    % Doing it manually.
    \blankpage      
    \blankpage 
    \blankpage
\fi

\end{document}

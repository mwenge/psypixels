\begin{figure}[H]
    \centering
    \begin{adjustbox}{width=10.5cm,center}
      \includegraphics[width=12cm]{src/tracking/pattern1-0-45.png}%
    \end{adjustbox}
    \begin{adjustbox}{width=10.5cm,margin=0cm -2cm}
      \includegraphics[width=12cm]{src/tracking/pattern1-1-45.png}%
    \end{adjustbox}
    \caption{Tracking 'on' (top) and 'off' (bottom).}
\end{figure}
\clearpage

\section*{tentative tracking} 
\label{sec:tracking}
\lstset{style=6502Style}
\lstset{ 
   aboveskip=5pt,
   belowskip=0pt,
}

\begin{definition}[Jeffrey Says\index{Jeffrey Says}]
\setlength{\intextsep}{0pt}%
\setlength{\columnsep}{3pt}%
\begin{wrapfigure}{l}{0.12\textwidth}
\includegraphics[width=\linewidth]{src/callout/psych.png} 
\end{wrapfigure}
\small
\textbf{T to Activate:} Controls\index{Controls} whether logic-seeking is used in
the buffer or not. The upshot of this for you is a slightly different
feel - continuous but fragmented when ON, or together-ish bursts
when OFF. Try it.
\\
\end{definition}

Tracking is 'on' by default and nearly all off the figures and diagrams we've used to illustrate
Psychedelia's behaviour have demonstrated the behaviour of 'tracking'. In essence, tracking means
using the values previously painted to a pixel position on screen as partial feedback into the next
color value that we will paint into it. 

When tracking is enabled the colors of pixels will change much more often, whereas when it is disabled
the display becomes much less interesting, with a more consistent and smoother evolution in the colors
of the patterns as they evolve.

\clearpage
\textbf{Lines 1362-1390. \icode{\textbf{MaybeTPressed\index{MaybeTPressed}}}} 
\begin{lstlisting}[escapechar=\%]
;-------------------------------------------------------
; CheckKeyboardInput%\index{CheckKeyboardInput}%
;-------------------------------------------------------
CheckKeyboardInput%\index{CheckKeyboardInput}%   
    ...
MaybeTPressed   
    CMP #KEY_T ; T pressed.
    BNE CheckIfPresetKeysPressed

    ; Toggle tracking on or off.
    LDA trackingActivated%\index{trackingActivated}%
    EOR #$FF
    STA trackingActivated%\index{trackingActivated}%

    ; Use the new setting to get an offset into our screen message.
    ; in txtTrackingOnOff
    AND #$01
    ASL 
    ASL 
    ASL 
    ASL 
    TAY 

    JSR ClearLastLineOfScreen%\index{ClearLastLineOfScreen}%

    ; Display the updated setting of 'tracking'.
    LDX #$00
txtTrackingLoop   
    LDA txtTrackingOnOff,Y
    STA lastLineBufferPtr,X
    INY 
    INX 
    CPX #$10
    BNE txtTrackingLoop

    JMP WriteLastLineBufferToScreen%\index{WriteLastLineBufferToScreen}%
    RTS 
\end{lstlisting}
\clearpage

\textbf{Lines 1362-1390. \icode{\textbf{MaybeTPressed}}:} 
Pressing \icode{T} toggles tracking on or off. Tracking's on/off state is 
stored in \icode{trackingActivated\index{trackingActivated}}, with \icode{\$00} meaning 'off' and
\icode{\$FF} meaning 'on'. This means we can use a neat, economical trick
for toggling the value every time the user presses the 'T' key:

\begin{lstlisting}[escapechar=\%]
    ; Toggle tracking on or off.
    LDA trackingActivated%\index{trackingActivated}%
    EOR #$FF
    STA trackingActivated%\index{trackingActivated}%
\end{lstlisting}

The \icode{EOR} statement performs an exclusive-or that has the neat property of
turning \icode{\$00} into \icode{\$FF} and \icode{\$FF} into \icode{\$00} - equivelent
to switching a value on or off.

This is what the the bit by bit operation looks like when '\icode{EOR \$FF}' turns
\icode{trackingActivated\index{trackingActivated}} 'on':

\begin{figure}[H]
  {
    \setlength{\tabcolsep}{3.0pt}
    \setlength\cmidrulewidth{\heavyrulewidth} % Make cmidrule = 
    \begin{adjustbox}{width=7cm,center}

      \begin{tabular}{rllllllll}
        \toprule
        Byte & Bit 7 & Bit 6 & Bit 5 & Bit 4 & Bit 3 & Bit 2 & Bit 1 & Bit 0        \\
        \midrule
        \$00 & 0 & 0 & 0 & 0 & 0 & 0 & 0 & 0 \\
        \$FF & 1 & 1 & 1 & 1 & 1 & 1 & 1 & 1 \\
        \midrule
        Result & 1 & 1 & 1 & 1 & 1 & 1 & 1 & 1 \\
        \addlinespace
        \bottomrule
      \end{tabular}

    \end{adjustbox}

  }\caption*{X-OR'ing \$FF and \$00 gives \$FF, the 'on' value for \icode{trackingActivated\index{trackingActivated}}.}
\end{figure}

And this is what it looks like when \icode{EOR \$FF} turns \icode{trackingActivated\index{trackingActivated}} 'off' again:
\begin{figure}[H]
  {
    \setlength{\tabcolsep}{3.0pt}
    \setlength\cmidrulewidth{\heavyrulewidth} % Make cmidrule = 
    \begin{adjustbox}{width=7cm,center}

      \begin{tabular}{rllllllll}
        \toprule
        Byte & Bit 7 & Bit 6 & Bit 5 & Bit 4 & Bit 3 & Bit 2 & Bit 1 & Bit 0        \\
        \midrule
        \$FF & 1 & 1 & 1 & 1 & 1 & 1 & 1 & 1 \\
        \$FF & 1 & 1 & 1 & 1 & 1 & 1 & 1 & 1 \\
        \midrule
        Result & 0 & 0 & 0 & 0 & 0 & 0 & 0 & 0 \\
        \addlinespace
        \bottomrule
      \end{tabular}

    \end{adjustbox}

  }\caption*{X-OR'ing \$FF and \$FF gives \$00, the 'off' value for \icode{trackingActivated\index{trackingActivated}}.}
\end{figure}
\clearpage

\clearpage
\textbf{Lines 728-943. \icode{\textbf{MainInterruptHandler}}} 
\begin{lstlisting}[escapechar=\%]
;-------------------------------------------------------
; MainInterruptHandler
;-------------------------------------------------------
MainInterruptHandler
        ...
        ; Finally, update the pixel buffers with a byte
        ; each for the current pattern.        
UpdatePixelBuffersForPattern    
        INC currentStepCount%\index{currentStepCount}%
        LDA currentStepCount%\index{currentStepCount}%
        CMP bufferLength%\index{bufferLength}%
        BNE UpdateBaseLevelArray

        LDA #$00
        STA currentStepCount%\index{currentStepCount}%

UpdateBaseLevelArray   
        TAX 
        LDA currentColorIndexArray%\index{currentColorIndexArray}%,X
        CMP #$FF
        BEQ UpdatePositionArrays

CheckIfTrackingActivated
        LDA previousIndexToPixelBuffers%\index{previousIndexToPixelBuffers}%
        AND trackingActivated%\index{trackingActivated}%
        BEQ DrawCursorAndReturnFromInterrupt%\index{DrawCursorAndReturnFromInterrupt}%

        TAX 
        LDA currentColorIndexArray%\index{currentColorIndexArray}%,X
        CMP #$FF
        BNE DrawCursorAndReturnFromInterrupt%\index{DrawCursorAndReturnFromInterrupt}%

        STX currentStepCount%\index{currentStepCount}%

UpdatePositionArrays   
        LDA cursorXPosition%\index{cursorXPosition}%
        STA pixelXPositionArray%\index{pixelXPositionArray}%,X
        LDA cursorYPosition%\index{cursorYPosition}%
        STA pixelYPositionArray%\index{pixelYPositionArray}%,X

        ...
DrawCursorAndReturnFromInterrupt%\index{DrawCursorAndReturnFromInterrupt}%    
        LDA #$01
        STA currentColorToPaint%\index{currentColorToPaint}%
        JSR PaintCursorAtCurrentPosition%\index{PaintCursorAtCurrentPosition}%
        ; Falls through
\end{lstlisting}
\clearpage

\textbf{Lines 728-943. \icode{\textbf{MainInterruptHandler}}:} 
As you may remember the \icode{MainInterruptHandler} runs every 1/60th of a
second.  You may also recall its main job is to fill the pixel buffers (e.g.
pixelXPositionArray\index{pixelXPositionArray}, pixelYPositionArray\index{pixelYPositionArray} and so on) so that the MainPaintLoop\index{MainPaintLoop}
can use them to paint the screen. 

\textbf{Lines 890-896. \icode{\textbf{CheckIfTrackingActivated}}:} 
\icode{trackingActivated\index{trackingActivated}} comes into play here. The idea is that if 'tracking'
is enabled then we should do a re-paint of the last entry in the buffers that was
processed by \icode{MainPaintLoop\index{MainPaintLoop}}. Naturally, if a pixel is being painted twice
over this will create a 'tracking' effect, as though the pattern is trailing a 
glowing tail after it.

We use the value in \icode{trackingActivated\index{trackingActivated}} to decide whether or not to paint
the previously processed position in the buffers by simply \icode{AND}'ing the
two together.

\begin{lstlisting}[escapechar=\%]
        LDA previousIndexToPixelBuffers%\index{previousIndexToPixelBuffers}%
        AND trackingActivated%\index{trackingActivated}%
        BEQ DrawCursorAndReturnFromInterrupt%\index{DrawCursorAndReturnFromInterrupt}%
\end{lstlisting}

If it's zero, we bail out
completely until the next interrupt by jumping to \icode{DrawCursor\-AndReturnFromInterrupt}.
But if we get a non-zero value that means tracking is enabled and 
we should go ahead and refresh the values in the buffers at the index given
by the value in \icode{previousIndex\-ToPixelBuffers}. So we 'fall through' instead to
\icode{UpdatePositionArrays} and a number of other sub-routines that update the
values of the previous position in our pixel buffers.

\clearpage
